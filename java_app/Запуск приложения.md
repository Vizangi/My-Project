Подробное руководство по запуску Spring Boot приложения с использованием Docker ComposeДанное руководство предоставляет подробные пошаговые инструкции по развертыванию Spring Boot приложения с использованием Docker и Docker Compose на основе предоставленного исходного кода и предварительных шагов. Целью является обеспечение полного понимания процесса для пользователей с любым уровнем опыта, с акцентом на максимальную детализацию каждого этапа.Предварительные требования: Установка Docker и Docker ComposeПрежде чем приступить к развертыванию приложения, необходимо установить Docker и Docker Compose на вашу операционную систему. Эти инструменты являются основой для контейнеризации и оркестрации нашего приложения.Установка DockerDocker предоставляет платформу для запуска приложений в изолированных средах, называемых контейнерами. Это обеспечивает согласованность окружения и упрощает процесс развертывания.1 Процесс установки Docker зависит от вашей операционной системы.macOS:Для пользователей macOS рекомендуется установить Docker Desktop. Перейдите на официальную страницу загрузки Docker Desktop для Mac https://docs.docker.com/desktop/install/mac-install/ и скачайте соответствующий .dmg файл.2 На странице загрузки вам будет предложено выбрать версию, совместимую с архитектурой вашего компьютера (Apple Silicon или Intel).3 После загрузки файла, дважды щелкните по нему, чтобы открыть. Затем перетащите иконку Docker в папку "Applications".2 Различные архитектуры процессоров требуют разных установщиков, что критически важно для корректной работы. Пользователи, которые не уверены в типе своего процессора, могут найти эту информацию в разделе "About This Mac" в меню Apple.Windows:Для пользователей Windows также рекомендуется установить Docker Desktop. Посетите страницу загрузки Docker Desktop для Windows https://docs.docker.com/desktop/install/windows-install/ и нажмите кнопку "Download for Windows".2 Запустите скачанный .exe файл и следуйте инструкциям мастера установки.4 Во время установки убедитесь, что опция "Enable WSL 2 Windows Features" выбрана.5 Подсистема Windows для Linux (WSL 2) обеспечивает лучшую производительность Docker на Windows и настоятельно рекомендуется к использованию. В случае возникновения проблем с WSL 2, обратитесь к официальному руководству по установке.5 Установка также может быть выполнена через командную строку с использованием команды "Docker Desktop Installer.exe" install или Start-Process 'Docker Desktop Installer.exe' -Wait install в PowerShell.4Linux (Ubuntu как пример):Процесс установки Docker на Linux может незначительно отличаться в зависимости от дистрибутива.1 Для Ubuntu выполните следующие команды в терминале 2:
Обновите список пакетов:
Bashsudo apt-get update


Установите необходимые пакеты для использования репозитория через HTTPS:
Bashsudo apt-get install apt-transport-https ca-certificates curl software-properties-common gnupg-agent


Добавьте официальный GPG ключ Docker:
Bashcurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg


Настройте стабильный репозиторий Docker:
Bashecho "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null


Установите Docker Engine, CLI и containerd:
Bashsudo apt-get update && sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

Установка на Linux требует более внимательного выполнения каждого шага для обеспечения корректной настройки.
Рекомендуется добавить вашего пользователя в группу docker, чтобы избежать необходимости использования sudo для каждой команды Docker:
Bashsudo groupadd docker
sudo usermod -aG docker $USER

После выполнения этой команды необходимо выйти из системы и снова войти или перезапустить Docker, чтобы изменения вступили в силу. Пользователи, забывающие добавить себя в группу docker, могут столкнуться с ошибками, связанными с правами доступа.
Существуют и альтернативные методы установки, такие как использование convenience script, предоставляемого Docker.1 Однако этот метод не рекомендуется для production-сред из-за отсутствия интерактивного контроля над процессом установки.Верификация установки Docker:После установки Docker необходимо убедиться, что он работает корректно. Откройте терминал или командную строку и выполните команду:Bashdocker --version
Эта команда должна вывести установленную версию Docker.2 Затем выполните команду для проверки работы Docker:Bashdocker run hello-world
Эта команда загрузит и запустит простой контейнер, который выведет приветственное сообщение от Docker.2 Успешное выполнение этих команд подтверждает, что Docker установлен и функционирует правильно.Установка Docker ComposeDocker Compose - это инструмент для определения и запуска многоконтейнерных Docker-приложений.8 Он использует YAML-файл для настройки сервисов, сетей и томов, из которых состоит ваше приложение. Docker Compose часто устанавливается вместе с Docker Desktop для macOS и Windows.2Проверка установки Docker Compose:Чтобы проверить, установлен ли Docker Compose, выполните в терминале следующую команду:Bashdocker compose version
Иногда может потребоваться использование команды:Bashdocker-compose --version
в зависимости от метода установки и версии Docker Compose.9 Команда должна вывести информацию о версии Docker Compose. Различие в командах (docker compose и docker-compose) связано с эволюцией Docker Compose и может вызывать путаницу, особенно у начинающих пользователей. Начиная с Docker Desktop версии 4.23.0, команда docker-compose указывает на бинарник Docker Compose V2, работающий в standalone режиме.9Отдельная установка Docker Compose на Linux:Если Docker Compose не был установлен вместе с Docker Desktop на Linux, вы можете установить его отдельно. Существует несколько способов установки, включая установку плагина Docker Compose через репозиторий пакетов или ручную установку бинарного файла.10Для установки плагина через репозиторий на Ubuntu и Debian выполните:Bashsudo apt-get update
sudo apt-get install docker-compose-plugin
Для ручной установки плагина загрузите бинарный файл и поместите его в директорию ~/.docker/cli-plugins/docker-compose, затем предоставьте права на выполнение:Bashmkdir -p ~/.docker/cli-plugins
curl -SL https://github.com/docker/compose/releases/download/v2.35.0/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
chmod +x ~/.docker/cli-plugins/docker-compose
Примечание: Рекомендуется проверить актуальную версию Docker Compose на странице релизов GitHub.10Также существует возможность установки standalone версии Docker Compose, хотя этот метод считается устаревшим.9 Пример команды для загрузки standalone версии:Bashsudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
Примечание: Версия 1.29.2 может быть не самой последней, рекомендуется проверить актуальную версию на странице релизов GitHub.12Выбор метода установки зависит от ваших предпочтений и операционной системы. Важно использовать правильные команды для установленной версии Docker Compose.Настройка структуры проектаПосле установки Docker и Docker Compose необходимо создать структуру каталогов для вашего приложения. В соответствии с предоставленными инструкциями, создайте корневую папку проекта с именем credit-pipeline в удобном для вас месте. Внутри этой папки создайте следующие подпапки 2:credit-pipeline/
├── src/
│   └── main/
│       ├── java/
│       │   └── com/
│       │       └── example/
│       │           └── creditpipeline/
│       └── resources/
└── pom.xml
└── Dockerfile
└── docker-compose.yml

src/main/java/com/example/creditpipeline: здесь будет размещен исходный код Java вашего приложения.
src/main/resources: эта папка предназначена для конфигурационных файлов Spring Boot, таких как application.properties или application.yml.
Эта структура каталогов является стандартной для проектов Spring Boot, использующих Maven.Размещение исходного кода JavaТеперь необходимо разместить предоставленный исходный код Java в соответствующие файлы, которые вы создали в предыдущем шаге. В папке src/main/java/com/example/creditpipeline создайте следующие файлы и скопируйте в них соответствующий код:
CreditPipelineApplication.java
CreditApplication.java
CreditApplicationRepository.java
PipelineService.java
PipelineController.java
Убедитесь, что имена файлов и содержимое полностью соответствуют предоставленному коду. Любые несоответствия могут привести к ошибкам компиляции или выполнения приложения.Настройка зависимостей проекта с помощью Maven (pom.xml)Для сборки Java-проекта, особенно Spring Boot, используется система управления зависимостями. В данном случае используется Maven, о чем свидетельствует предоставленный файл pom.xml. Создайте файл pom.xml в корневой папке credit-pipeline и скопируйте в него следующее содержимое:XML<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.0</version>
        <relativePath/>
    </parent>
    <groupId>com.example</groupId>
    <artifactId>credit-pipeline</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>credit-pipeline</name>
    <description>Credit Pipeline Application</description>
    <properties>
        <java.version>17</java.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>com.github.javafaker</groupId>
            <artifactId>javafaker</artifactId>
            <version>1.0.2</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>2.0.9</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-log4j2</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
Файл pom.xml описывает структуру проекта, его зависимости и конфигурацию сборки.
<project> является корневым элементом.
<modelVersion>4.0.0</modelVersion> указывает версию модели POM.
<parent> определяет родительский POM, от которого наследуется конфигурация. В данном случае это spring-boot-starter-parent от Spring Boot.14 Версия 3.2.0, указанная здесь, может быть не самой последней стабильной версией. На момент написания отчета, последней стабильной версией Spring Boot является 3.4.4.14 Рекомендуется использовать актуальную версию для получения последних функций и исправлений.
<groupId>, <artifactId>, <version>, <name>, <description> содержат базовую информацию о вашем проекте.
<properties> определяет свойства проекта, включая версию Java (java.version>17</java.version>). Spring Boot 3.4.x поддерживает версии Java от 17 до 23 17, поэтому Java 17 является совместимой версией.
<dependencies> содержит список внешних библиотек, необходимых для работы приложения.

spring-boot-starter-web необходим для создания веб-приложений, включая REST API.14
spring-boot-starter-data-jpa обеспечивает поддержку работы с базами данных через JPA.14
h2 - это легковесная встраиваемая база данных, используемая во время выполнения.2
javafaker используется для генерации фейковых данных.2 Версия 1.0.2 указана в примере. Рекомендуется проверить последнюю версию на Maven Repository.
spring-boot-starter-test необходим для написания и запуска тестов.2
slf4j-api предоставляет интерфейс для логирования.2 Версия 2.0.9 указана в примере. Рекомендуется проверить последнюю версию.
spring-boot-starter-log4j2 обеспечивает интеграцию с библиотекой логирования Log4j2.
lombok используется для автоматической генерации boilerplate-кода.2


<build> содержит конфигурацию сборки проекта, включая использование плагина spring-boot-maven-plugin, который необходим для создания исполняемого JAR-файла.2
Maven автоматически загрузит все указанные зависимости при сборке проекта. Неправильное указание версий зависимостей может привести к конфликтам и ошибкам.Создание Dockerfile для приложенияDockerfile содержит инструкции для сборки Docker-образа вашего приложения. Создайте файл с именем Dockerfile в корневой папке credit-pipeline и скопируйте в него следующее содержимое:DockerfileFROM openjdk:17-jdk-slim

WORKDIR /app

COPY target/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "/app/app.jar"]

FROM openjdk:17-jdk-slim указывает, что базовым образом будет образ JDK 17 на базе slim-версии Linux.2 Рекомендуется использовать актуальные и безопасные базовые образы.
WORKDIR /app устанавливает рабочую директорию внутри контейнера в /app.
COPY target/*.jar app.jar копирует собранный JAR-файл приложения из локальной папки target/ (где Maven сохраняет собранные артефакты) в директорию /app внутри контейнера и переименовывает его в app.jar. Важно отметить, что перед сборкой Docker-образа необходимо собрать приложение с помощью Maven. В исходном примечании была указана папка build/libs/, но для Maven стандартной папкой является target/.
EXPOSE 8080 сообщает Docker, что приложение будет прослушивать порт 8080.
ENTRYPOINT ["java", "-jar", "/app/app.jar"] определяет команду, которая будет выполняться при запуске контейнера - запуск Java-приложения.
Dockerfile содержит пошаговые инструкции для создания Docker-образа, включающего все необходимое для запуска приложения. Ошибки в Dockerfile могут привести к проблемам при сборке образа или запуске контейнера.Настройка Docker Compose для запуска приложения и базы данных (docker-compose.yml)Файл docker-compose.yml используется для определения и настройки всех сервисов, составляющих ваше приложение. В данном случае это будет ваше Spring Boot приложение и база данных PostgreSQL. Создайте файл docker-compose.yml в корневой папке credit-pipeline и скопируйте в него следующее содержимое:YAMLversion: '3.8'
services:
  credit-pipeline:
    build:.
    ports:
      - "8080:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/credit_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
    depends_on:
      - db
  db:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=credit_db
    volumes:
      - db_data:/var/lib/postgresql/data/

volumes:
  db_data:

version: '3.8' указывает версию формата файла Docker Compose. Рекомендуется использовать актуальную версию.
services: определяет сервисы, которые будут запущены.

credit-pipeline: - сервис для вашего Spring Boot приложения.

build:. указывает Docker Compose собрать образ из Dockerfile, находящегося в текущей директории.
ports: - "8080:8080" пробрасывает порт 8080 с хост-машины на порт 8080 контейнера, делая приложение доступным по http://localhost:8080.
environment: определяет переменные окружения для приложения.

SPRING_DATASOURCE_URL - URL для подключения к базе данных PostgreSQL. db - имя сервиса базы данных. 5432 - стандартный порт PostgreSQL. credit_db - имя базы данных.
SPRING_DATASOURCE_USERNAME и SPRING_DATASOURCE_PASSWORD - учетные данные для подключения к базе данных.
SPRING_JPA_HIBERNATE_DDL_AUTO=update позволяет Hibernate автоматически обновлять схему базы данных при запуске (подходит для разработки). В production-среде рекомендуется использовать более контролируемые методы управления схемой.


depends_on: - db указывает, что сервис credit-pipeline должен запускаться после сервиса db.


db: - сервис для базы данных PostgreSQL.

image: postgres:15-alpine использует готовый образ PostgreSQL версии 15 с Alpine Linux.2 Рекомендуется проверить последнюю стабильную версию PostgreSQL на Docker Hub.18 На момент написания доступны более новые версии, такие как 17.4.19 Выбор версии зависит от требований приложения.
ports: - "5432:5432" пробрасывает порт 5432 с хост-машины на порт 5432 контейнера базы данных.
environment: определяет переменные окружения для базы данных.

POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB - учетные данные и имя базы данных PostgreSQL. В production-среде необходимо использовать более надежные пароли.


volumes: - db_data:/var/lib/postgresql/data/ монтирует именованный том db_data к директории с данными PostgreSQL внутри контейнера, обеспечивая сохранение данных между перезапусками.




volumes: определяет именованные тома.

db_data: - том для хранения данных PostgreSQL.


Файл docker-compose.yml описывает все необходимые сервисы и их взаимодействие. Неправильная настройка переменных окружения или портов может привести к проблемам с подключением.Сборка и запуск приложения с помощью Docker Compose
Откройте терминал или командную строку.
Перейдите в корневую папку credit-pipeline с помощью команды cd <путь_к_папке>/credit-pipeline.
Если вы используете Maven, выполните команду для сборки приложения:
Bashmvn clean package

Эта команда очистит предыдущие сборки и соберет приложение, создав JAR-файл в папке target/.
Если вы используете Gradle, выполните команду:
Bashgradle clean build


Выполните команду для запуска приложения и базы данных с помощью Docker Compose:
Bashdocker-compose up -d

Эта команда соберет Docker-образ (если он еще не собран) и запустит контейнеры, определенные в docker-compose.yml, в фоновом режиме. При первом запуске Docker Compose может загружать необходимые образы из Docker Hub.
Проверка работы приложения
Выполните команду для проверки статуса запущенных контейнеров:
Bashdocker-compose ps

Убедитесь, что оба сервиса (credit-pipeline и db) находятся в состоянии Up.
Откройте веб-браузер и перейдите по адресу http://localhost:8080. Ваше Spring Boot приложение должно быть доступно по этому адресу.
Вы можете использовать инструменты вроде curl или Postman для взаимодействия с API приложения.

Для отправки POST-запроса на создание новой заявки выполните:
Bashcurl -X POST http://localhost:8080/api/pipeline/submit -H "Content-Type: application/json" -d '{"applicantName": "Иван Иванов", "amount": 10000}'

Можно также отправить пустой запрос, и приложение сгенерирует тестовые данные.
Для получения списка всех заявок выполните:
Bashcurl http://localhost:8080/api/pipeline/applications


Для получения заявки по ID выполните:
Bashcurl http://localhost:8080/api/pipeline/applications/<UUID>

Замените <UUID> на фактический ID заявки.


Вы можете проверить логи приложения с помощью команды:
Bashdocker-compose logs credit-pipeline


ЗаключениеВ данном руководстве были подробно рассмотрены шаги по запуску Spring Boot приложения с использованием Docker и Docker Compose. Были рассмотрены установка Docker и Docker Compose, настройка структуры проекта, размещение исходного кода, конфигурация зависимостей Maven, создание Dockerfile и настройка docker-compose.yml для запуска приложения вместе с базой данных PostgreSQL. Использование Docker и Docker Compose значительно упрощает процесс развертывания приложений, обеспечивая согласованность окружения и удобное управление многоконтейнерными приложениями. Для дальнейшего изучения рекомендуется ознакомиться с более подробной документацией по Docker, Docker Compose и Spring Boot.
